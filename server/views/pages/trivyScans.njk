{% extends "../partials/layout.njk" %}
{% from "govuk/components/checkboxes/macro.njk" import govukCheckboxes %}
{% from "govuk/components/select/macro.njk" import govukSelect %}
{% from "govuk/components/button/macro.njk" import govukButton %}

{% set pageTitle = applicationName + " - Trivy Scan Results" %}
{% set mainClasses = "app-container govuk-body" %}
{% set containerClasses = "wide-screen" %}

{% block content %}

{{ breadCrumb("Trivy Scans", []) }}

  <h1>Trivy Scan Results</h1>
  <p><strong>Use either the Team filter or the Portfolio filter â€” but not both at the same time.</strong></p>
  <form>
		<div class="trivy-filter govuk-button-group">
      <div class="label-and-button">
        {{ govukSelect({
          id: "team",
          name: "team",
          label: {
          text: "Team",
          classes: "govuk-fieldset__legend--s"
          },
          items: team
        }) }}
        {{ govukButton({
          id: "updateTeam",
          name: "updateTeam",
          text: "Update",
          element: "button",
          attributes: { "data-associated-select-id": "team", "data-type-name": "teams"}
        }) }}
      </div>
      <div class="label-and-button">
        {{ govukSelect({
          id: "portfolio",
          name: "portfolio",
          label: {
          text: "Portfolio",
          classes: "govuk-fieldset__legend--s"
          },
          items: portfolio
        }) }}
        {{ govukButton({
          id: "updatePortfolio",
          name: "updatePortfolio",
          text: "Update",
          element: "button",
          attributes: { "data-associated-select-id": "portfolio", "data-type-name": "portfolio"}
        }) }}
      </div>
		</div>
  </form>

<input type="hidden" name="monitorName" id="monitorName" value="{{ monitorName }}">
<input type="hidden" name="monitorType" id="monitorType" value="{{ monitorType }}">
<input type="hidden" name="monitorId" id="monitorId" value="{{ monitorId }}">
<input type="hidden" name="_csrf" id="csrf" value="{{ csrfToken }}">


<div class="govuk-grid-row">
  <div class="govuk-grid-column-one-third">
    {{ govukCheckboxes({
      name: "environment",
      classes: "govuk-checkboxes--small environments",
      fieldset: {
        legend: {
          text: "Environment",
          classes: "govuk-fieldset__legend--s"
        }
      },
      items: [
        {
          id: "environment-prod",
          value: "prod",
          text: "Prod",
          checked: true
        },
        {
          id: "environment-preprod",
          value: "preprod",
          text: "PreProd",
          checked: true
        },
        {
          id: "environment-test",
          value: "test",
          text: "Test",
          checked: true
        },
        {
          id: "environment-stage",
          value: "stage",
          text: "Stage",
          checked: true
        },
        {
          id: "environment-dev",
          value: "dev",
          text: "Dev",
          checked: true
        },
        {
          id: "environment-unknown",
          value: "unknown",
          text: "Unknown (latest image)",
          checked: true
        }
      ]
    }) }}
</div>
  <div class="govuk-grid-column-one-third">
    {{ govukCheckboxes({
      name: "severity",
      classes: "govuk-checkboxes--small severity",
      fieldset: {
        legend: {
          text: "Severity",
          classes: "govuk-fieldset__legend--s"
        }
      },
      items: [
        {
          id: "showSeverityCritical",
          value: "critical",
          text: "Critical",
          checked: true
        },
        {
          id: "showSeverityHigh",
          value: "high",
          text: "High",
          checked: true
        },
        {
          id: "showSeverityMedium",
          value: "medium",
          text: "Medium",
          checked: false
        },
        {
          id: "showSeverityLow",
          value: "low",
          text: "Low",
          checked: false
        },
        {
          id: "showSeverityUnknown",
          value: "unknown",
          text: "Unknown",
          checked: false
        }
      ]
    }) }}
</div>
  <div class="govuk-grid-column-one-third">
    {{ govukCheckboxes({
      name: "vulnerabilities",
      classes: "govuk-checkboxes--small vulnerability",
      fieldset: {
        legend: {
          text: "Vulnerabilities with",
          classes: "govuk-fieldset__legend--s"
        }
      },
      items: [
        {
          id: "showAvailable",
          value: "fix available",
          text: "Fix available (F)",
          checked: true
        },
        {
          id: "showUnavailable",
          value: "fix unavailable",
          text: "Fix unavailable (N)",
          checked: true
        },
        {
          id: "showNoVulnerabilities",
          value: "no vulnerabilities",
          text: "No vulnerabilities",
          checked: true
        }
      ]
    }) }}
  </div>
</div>

  <br>
  <p><strong>Note:</strong> The latest images are not retrieved from the health endpoint, making it unclear which environment they are deployed in.</p>
  <table id="trivyScansTable" class="stripe">
    <thead>
      <tr>
        <th class="name">Name</th>
        <th class="environments">Environment</th>
        <th class="result">Results</th>
        <th>Image</th>
        <th>Scan Timestamp</th>
        <th class="count">C(F)</th>
        <th class="count">H(F)</th>
        <th class="count">M(F)</th>
        <th class="count">L(F)</th>
        <th class="count">U(F)</th>
        <th class="count">C(N)</th>
        <th class="count">H(N)</th>
        <th class="count">M(N)</th>
        <th class="count">L(N)</th>
        <th class="count">U(N)</th>
        <th class="count">Secrets</th>
        <th class="cve">CVE IDs</th>
      </tr>
    </thead>
    <tfoot>
      <tr>
        <th class="name">Name</th>
        <th class="environments">Environment</th>
        <th class="result">Results</th>
        <th>Image</th>
        <th>Scan Timestamp</th>
        <th class="count">C(F)</th>
        <th class="count">H(F)</th>
        <th class="count">M(F)</th>
        <th class="count">L(F)</th>
        <th class="count">U(F)</th>
        <th class="count">C(N)</th>
        <th class="count">H(N)</th>
        <th class="count">M(N)</th>
        <th class="count">L(N)</th>
        <th class="count">U(N)</th>
        <th class="count">Secrets</th>
        <th class="cve">CVE IDs</th>
      </tr>
    </tfoot>
  </table>
{% endblock %}

{% block bodyEnd %}
  <script type="module" src="/assets/frontendInit.js"></script>

  <script src="/assets/js/common.js"></script>
  <script src="/assets/js/trivyScans.js"></script>
{% endblock %}
