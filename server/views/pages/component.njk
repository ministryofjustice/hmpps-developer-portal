{% extends "../partials/layout.njk" %}

{% set pageTitle = applicationName + " - " + component.name %}
{% set mainClasses = "app-container govuk-body" %}

{% block content %}

<h1 id="detailPageTitle">{{ component.name }}</h1>

<p>{{ component.description }}</p>
<p>Title: {{ component.title }}</p>
<p>Jira Project Keys: {{ component.jiraProjectKeys }}</p>
<p>GitHub Write: {{ component.githubWrite }}</p>
<p>GitHub Admin: {{ component.githubAdmin }}</p>
<p>GitHub Restricted: {{ component.githubRestricted }}</p>
<p>GitHub Repo: {{ component.githubRepo }}</p>
<p>GitHub Visibility: {{ component.githubVisibility }}</p>
<p>App Insights Cloud Role Name: {{ component.appInsightsName }}</p>
<p>API: {% if component.api %}Yes{% else %}No{% endif %}</p>
<p>Frontend: {% if component.frontend %}Yes{% else %}No{% endif %}</p>
<p>Part of monorepo: {% if component.partOfMonorepo %}Yes{% else %}No{% endif %}</p>
<p>Language: {{ component.language }}</p>
<p>Product: <a href="/products/{{ component.product.id }}">{{ component.product.attributes.name }}</a></p>
<p>Environments</p>
{% if component.environments | length %}
<table>
  <tbody>
    <tr>
      <th>ID</th>
      {% for environment in component.environments %}
      <td>{{ environment.id }}</td>
      {% endfor %}
    </tr>
    <tr>
      <th>Name</th>
      {% for environment in component.environments %}
      <td>{{ environment.name }}</td>
      {% endfor %}
    </tr>
    <tr>
      <th>Namespace</th>
      {% for environment in component.environments %}
      <td>{{ environment.namespace }}</td>
      {% endfor %}
    </tr>
    <tr>
      <th>Info</th>
      {% for environment in component.environments %}
      <td>{{ environment.info_path }}</td>
      {% endfor %}
    </tr>
    <tr>
      <th>Health</th>
      {% for environment in component.environments %}
      <td>{{ environment.health_path }}</td>
      {% endfor %}
    </tr>
    <tr>
      <th>URL</th>
      {% for environment in component.environments %}
      <td><a href="{{ environment.url }}">{{ environment.url }}</a></td>
      {% endfor %}
    </tr>
    <tr>
      <th>Cluster</th>
      {% for environment in component.environments %}
      <td>{{ environment.cluster }}</td>
      {% endfor %}
    </tr>
    <tr>
      <th>Version</th>
      {% for environment in component.environments %}
      <td id="{{ environment.name }}_version"></td>
      {% endfor %}
    </tr>
    <tr>
      <th>Status</th>
      {% for environment in component.environments %}
      <td id="{{ environment.name }}_status"></td>
      {% endfor %}
    </tr>
  </tbody>
</table>
{% else %}
<p>None</p>
{% endif %}

{% endblock %}

{% block bodyEnd %}
  <script src="/assets/govuk/all.js"></script>
  <script src="/assets/govukFrontendInit.js"></script>
  <script src="/assets/moj/all.js"></script>

  <script nonce="{{ cspNonce }}">
    const lastIds = {}
    const data = {}
    {% for environment in component.environments -%}
    lastIds['h:{{ environment.name }}'] = '0-0'
    lastIds['i:{{ environment.name }}'] = '0-0'
    lastIds['v:{{ environment.name }}'] = '0-0'
    data['h:{{ environment.name }}'] = ''
    data['i:{{ environment.name }}'] = ''
    data['v:{{ environment.name }}'] = ''
    {% endfor -%}

    const fetchMessages = async (queryStringOptions) => {
      const queryString = new URLSearchParams(queryStringOptions).toString()

      try {
        const response = await fetch(`/components/queue/{{ component.id }}/${queryString}`)

        if (!response.ok) {
          throw new Error('There was a problem fetching the component data')
        }

        const streamJson = await response.json()

        streamJson.forEach(stream => {
          const streamName = stream.name.split(':')
          const streamType = streamName[0].charAt(0)
          const streamKey = `${streamType}:${streamName[2]}`

          if (lastIds[streamKey]) {
            lastIds[streamKey] = stream.messages[0].id
          }
          if (data.hasOwnProperty(streamKey)) {
            data[streamKey] = stream.messages[0].message

            switch (streamType) {
              case 'v':
                $(`#${streamName[2]}_version`).text(data[streamKey].v)
                break
              case 'h':
                const jsonData = data[streamKey].json.replaceAll('\'', '"') // temp fix
                const status = JSON.parse(jsonData)
                $(`#${streamName[2]}_status`).text(status.status)
                break
            }
          }
        })
        console.log(data)
      } catch (e) {
        console.error(e)
      }
    }


    jQuery(function () {
      fetchMessages(lastIds)
    })
  </script>
{% endblock %}
