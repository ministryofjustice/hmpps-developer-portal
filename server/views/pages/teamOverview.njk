{%- from "moj/components/alert/macro.njk" import mojAlert -%}More actions
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{%- from "moj/components/badge/macro.njk" import mojBadge -%}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "govuk/components/warning-text/macro.njk" import govukWarningText %}
{% from "../partials/driftRadiatorTable.njk" import driftRadiatorTable %}
{% extends "../partials/layout.njk" %}

{% set pageTitle = applicationName + " - " + team.name %}
{% set mainClasses = "app-container govuk-body" %}

{% block content %}

  {{ breadCrumb(team.name, [{title: "Teams", href: "/teams"}]) }}

  {% call govukInsetText({ classes: "govuk-!-margin-0 guidance-panel" }) %}
    <p>The information on this page relates to products and components in the production environment only</p>
  {% endcall %}

  <h1>{{ team.name }}</h1>

  {% if team.slackChannelId and team.slackChannelName %}
    <h3>
      Slack Channel:
      <a href="slack://channel?team={{ team.slackWorkspaceId }}&id={{ team.slackChannelId }}" class="slack-icon">#{{ team.slackChannelName }}</a>
    </h3>
  {% endif %}

  {% if team.alertSummary.total > 0 %}
    {{ mojAlert({
      variant: "warning",
      title: "Active Alerts",
      showTitleAsHeading: true,
      dismissible: false,
      html: 'There are actively triggering alerts on one or more components. <a href="/alerts?environment=prod&team=' + team.encodedTeamName + '">Please see active alerts for more</a>.'
    }) }}
  {% else %}
    {{ mojAlert({
      variant: "information",
      title: "No Active Alerts",
      showTitleAsHeading: true,
      dismissible: false,
      html: 'There are currently no actively triggering alerts.'
    }) }}
  {% endif %}

  <h3 class="govuk-heading-m">Alerts and scans requiring investigation</h3>

  <div class="govuk-grid-row hmpps-miniSummaryWrapper govuk-!-margin-bottom-6">
    <div class="govuk-grid-column-one-third">
      <div class= alertsAndScansCard>
        {{ govukSummaryList({
          card: {
            title: {
              text: "Active Alerts"
            }
          },
          rows: [
            {
              key: {
                text: team.alertSummary.total, classes: "totalNumber"
              },
              value: {
                html: '<a href="/alerts?environment=prod&team=' + team.encodedTeamName + '" class="govuk-link">See active alerts</a>'
              },
              classes: "alertsAndScansBox"
            }
          ]
        }) }}
      </div>
    </div>

    <div class="govuk-grid-column-one-third">
      <div class= alertsAndScansCard>
        {{ govukSummaryList({
          card: {
            title: {
              text: "Trivy (critical & high)"
            }
          },
          rows: [
            {
              key: {
                text: team.criticalAndHighTrivy, classes: "totalNumber"
              },
              value: {
                html: '<a href="/trivy-scans?checkbox=environment-prod&team=' + team.encodedTeamName + '" class="govuk-link">See Trivy scan results</a>'
              },
              classes: "alertsAndScansBox"
            }
          ]
        }) }}
      </div>
    </div>

    <div class="govuk-grid-column-one-third">
      <div class= alertsAndScansCard>
        {{ govukSummaryList({
          card: {
            title: {
              text: "Veracode (very high & high)"
            }
          },
          rows: [
            {
              key: {
                text: team.veryHighAndHighVeracode, classes: "totalNumber"
              },
              value: {
                html: '<a href="/veracode?team=' + team.encodedTeamName + '" class="govuk-link">See Veracode scan results</a>'
              },
              classes: "alertsAndScansBox"
            }
          ]
        }) }}
      </div>
    </div>
  </div>

  {% if team.channelRecommendations %}
    <h3 class="govuk-heading-m">Monitoring Channel Recommendations</h3>

    <div class="govuk-grid-row">
      <div class="govuk-grid-column-full">
        {% if team.hasLegacyChannels %}
          <div class="govuk-warning-text monitoring-channel-warning">
            <div class="monitoring-channel-count">
              {{ team.legacyChannelCount }}
            </div>
            <div class="monitoring-channel-details">
              <div class="monitoring-channel-header">
                <span class="govuk-warning-text__icon monitoring-channel-icon" aria-hidden="true">!</span>
                <strong class="monitoring-channel-title">Action Required</strong>
              </div>
              <p class="govuk-body monitoring-channel-text">
                Your team has <strong>{{ team.legacyChannelCount }} component{{ 's' if team.legacyChannelCount != 1 else '' }}</strong> using shared DPS alert channels (#dps_alerts, #dps_alerts_non_prod).
                We recommend migrating to dedicated team channels for better alert management and reduced noise.
              </p>
            </div>
          </div>
        {% endif %}

        {% if team.channelRecommendations.recommendations.length == 0 %}
          <div class="govuk-inset-text">
            <p class="govuk-body">This team currently has no components. If you create one, consider using the suggested alerting channel.</p>
          </div>
        {% endif %}

        <div class="govuk-summary-card" data-test-id="monitoring-recommendations">
          <div class="govuk-summary-card__title-wrapper">
            <h2 class="govuk-summary-card__title">Suggested Channel Structure</h2>
          </div>
          <div class="govuk-summary-card__content">
            {% if team.channelRecommendations.recommendations.length > 0 %}
              <p class="govuk-body">Based on your team's components, we recommend the following Slack channel structure for monitoring alerts:</p>
            {% else %}
              <p class="govuk-body">We recommend the following Slack channel structure for monitoring alerts when you create components:</p>
            {% endif %}

            <div class="govuk-grid-row">
              <div class="govuk-grid-column-one-half">
                <h4 class="govuk-heading-s">Recommended Channels</h4>
                <ul class="govuk-list govuk-list--bullet">
                  <li><strong>{{ team.channelRecommendations.suggestedChannels.nonProd }}</strong> - For dev and preprod alerts</li>
                  <li><strong>{{ team.channelRecommendations.suggestedChannels.prod }}</strong> - For production alerts</li>
                  <li class="govuk-hint govuk-body-s">Alternative: <strong>{{ team.channelRecommendations.suggestedChannels.prodAlt }}</strong> - Shorter prod channel name</li>
                </ul>
              </div>
              <div class="govuk-grid-column-one-half">
                <h4 class="govuk-heading-s">Channel Structure</h4>
                <pre class="govuk-body-s monitoring-channel-structure">{% for line in team.channelTree %}{{ line }}
                {% endfor %}</pre>
              </div>
            </div>

            {% if team.channelRecommendations.recommendations.length > 0 %}
              <details class="govuk-details" data-module="govuk-details">
                <summary class="govuk-details__summary">
                  <span class="govuk-details__summary-text">Component-by-component breakdown</span>
                </summary>
                <div id = componentBreakdownTable class="govuk-details__text">
                  {% set componentRow = [] %}
                  {% for rec in team.channelRecommendations.recommendations %}
                    {% set componentSubRowContent = [
                    [
                      { text: 'Dev' },
                      { text: rec.environments.dev },
                      { text: rec.currentChannels.dev or 'Not configured' }
                    ],
                    [
                      { text: 'PreProd' },
                      { text: rec.environments.preprod },
                      { text: rec.currentChannels.preprod or 'Not configured' }
                    ],
                    [
                      { text: 'Prod' },
                      { text: rec.environments.prod },
                      { text: rec.currentChannels.prod or 'Not configured' }
                    ]
                    ] %}
                    {% set rowData = [] %}

                    {% for subRow in componentSubRowContent %}
                      {% if loop.first %}
                        {% set componentRowContent = [
                          { text: rec.componentName, rowspan: componentSubRowContent.length },
                          subRow[0],
                          subRow[1],
                          subRow[2]
                        ] %}
                      {% else %}
                        {% set  componentRowContent = [
                          subRow[0],
                          subRow[1],
                          subRow[2]
                        ] %}
                      {% endif %}

                      {% set rowData = rowData.concat([componentRowContent]) %}
                    {% endfor %}
                    {% set componentRow = componentRow.concat(rowData) %}
                  {% endfor %}

                  {{ govukTable({
                    firstCellIsHeader: false,
                    head: [
                      { text: "Component" },
                      { text: "Environment" },
                      { text: "Recommended Channel" },
                      { text: "Current Channel" }
                    ],
                    rows: componentRow
                  }) }}
                </div>
              </details>
            {% endif %}

            <div class="govuk-inset-text">
              <p class="govuk-body-s">
                <strong>Benefits of this structure:</strong>
              </p>
              <ul class="govuk-list govuk-list--bullet govuk-body-s">
                <li>Separates production alerts from non-production to reduce noise</li>
                <li>Centralizes team alerts in dedicated channels</li>
                <li>Follows consistent naming conventions</li>
                <li>Enables better alert management and response times</li>
                <li><strong>Migrates away from shared channels like #dps_alerts</strong> to team-specific channels</li>
              </ul>
            </div>

            {% if hasLegacyChannels %}
            {{ govukWarningText({
              text: "Your team is currently using shared DPS alert channels (#dps_alerts, #dps_alerts_non_prod).
                   We recommend migrating to dedicated team channels for better alert management and reduced noise.",
              iconFallbackText: "Warning"
            }) }}
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  {% if team.componentList.length > 0 %}
    <h3 class="govuk-heading-m">Component Drift Radiator</h3>
    {{ driftRadiatorTable() }}
  {% endif %}

{% endblock %}

{% block bodyEnd %}
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="/assets/js/dayjs/dayjs.min.js"></script>
  <script src="/assets/js/dayjs/plugin/relativeTime.js"></script>
  <script src="/assets/js/driftRadiator.js"></script>
  <script nonce="{{ cspNonce }}">
    jQuery(function () {
      const components = {{team.componentList | toJson(2) | safe }}
      const csrfToken = "{{ csrfToken }}"
      const renderer = new DeploymentRenderer(csrfToken, 'list')
      renderer.start(components)
    })
  </script>
{% endblock %}

{% block pageScripts %}
  <script src="/assets/js/monitoringChannels.js"></script>
{% endblock %}
