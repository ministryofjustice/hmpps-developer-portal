{%- from "moj/components/alert/macro.njk" import mojAlert -%}More actions
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{%- from "moj/components/badge/macro.njk" import mojBadge -%}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{% extends "../partials/layout.njk" %}

{% set pageTitle = applicationName + " - " + teamName %}
{% set mainClasses = "app-container govuk-body" %}

{% block content %}

{{ breadCrumb(teamName, [{title: "Teams", href: "/teams"}]) }}

<h1>{% if teamName %}{{ teamName }}{% else %}Team Overview{% endif %}</h1>

{% if teamAlertSummary.total > 0 %}
  {{ mojAlert({
    variant: "warning",
    title: "Active Alerts",
    showTitleAsHeading: true,
    dismissible: false,
    html: 'There are actively triggering alerts on one or more components. <a href="/alerts?team=' + formatTeamNameURL + '">Please see active alerts for more</a>.'
  }) }}
{% else %}
  {{ mojAlert({
    variant: "information",
    title: "No Active Alerts",
    showTitleAsHeading: true,
    dismissible: false,
    html: 'There are currently no actively triggering alerts.'
  }) }}
{% endif %}

<h3 class="govuk-heading-m">Alerts and scans requiring investigation</h3>

<div class="govuk-grid-row hmpps-miniSummaryWrapper govuk-!-margin-bottom-6">
  <div class="govuk-grid-column-one-third">
    <div class="govuk-summary-card">
      <div class="govuk-summary-card__content">
        <dl class="govuk-summary-list">
          <dt class="govuk-summary-list__key">
            Active Alerts
          </dt>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key govuk-body govuk-!-font-size-48">
           {{ teamAlertSummary.total }}
          </dt>
        </div>
          <div class="govuk-summary-list__row">
            <dd class="govuk-summary-list__value">
              <a class="govuk-link" href="/alerts?team={{ formatTeamNameURL }}">See active alerts</a>
            </dd>
          </div>
        </dl>
      </div>
    </div>
    </div>
    <div class="govuk-grid-column-one-third">
    <div class="govuk-summary-card">
      <div class="govuk-summary-card__content">
        <dl class="govuk-summary-list">
            <dt class="govuk-summary-list__key">
              Trivy (critical & high)
            </dt>
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key govuk-body govuk-!-font-size-48">
              {{ criticalAndHighTrivy }}
            </dt>
          </div>
          <div class="govuk-summary-list__row">
            <dd class="govuk-summary-list__value">
              <a class="govuk-link" href="/trivy-scans?team={{ formatTeamNameURL }}">See Trivy scan results</a>
            </dd>
          </div>
        </dl>
      </div>
    </div>
    </div>
    <div class="govuk-grid-column-one-third">
    <div class="govuk-summary-card">
      <div class="govuk-summary-card__content">
        <dl class="govuk-summary-list">
            <dt class="govuk-summary-list__key">
              Veracode (very high & high)
            </dt>
          <div class="govuk-summary-list__row">
            <dt class="govuk-summary-list__key govuk-body govuk-!-font-size-48">
              {{ veryHighAndHighVeracode }}
            </dt>
          </div>
          <div class="govuk-summary-list__row">
            <dd class="govuk-summary-list__value">
              <a class="govuk-link" href="/veracode?team={{ formatTeamNameURL }}">See veracode scan results</a>
            </dd>
          </div>
        </dl>
      </div>
    </div>
  </div>
</div>

{% if channelRecommendations %}
<h3 class="govuk-heading-m">Monitoring Channel Recommendations</h3>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <div class="govuk-summary-card" data-test-id="monitoring-recommendations">
      <div class="govuk-summary-card__title-wrapper">
        <h2 class="govuk-summary-card__title">Suggested Channel Structure</h2>
      </div>
      <div class="govuk-summary-card__content">
        <p class="govuk-body">Based on your team's components, we recommend the following Slack channel structure for monitoring alerts:</p>
        
        <div class="govuk-grid-row">
          <div class="govuk-grid-column-one-half">
            <h4 class="govuk-heading-s">Recommended Channels</h4>
            <ul class="govuk-list govuk-list--bullet">
              <li><strong>{{ channelRecommendations.suggestedChannels.nonLive }}</strong> - For dev and preprod alerts</li>
              <li><strong>{{ channelRecommendations.suggestedChannels.live }}</strong> - For production alerts</li>
            </ul>
          </div>
          <div class="govuk-grid-column-one-half">
            <h4 class="govuk-heading-s">Channel Structure</h4>
            <pre class="govuk-body-s" style="background-color: #f3f2f1; padding: 15px; border-radius: 4px; font-family: monospace;">{% for line in channelTree %}{{ line }}
{% endfor %}</pre>
          </div>
        </div>

        {% if channelRecommendations.recommendations.length > 0 %}
        <details class="govuk-details" data-module="govuk-details">
          <summary class="govuk-details__summary">
            <span class="govuk-details__summary-text">
              Component-by-component breakdown
            </span>
          </summary>
          <div class="govuk-details__text">
            <table class="govuk-table">
              <thead class="govuk-table__head">
                <tr class="govuk-table__row">
                  <th scope="col" class="govuk-table__header">Component</th>
                  <th scope="col" class="govuk-table__header">Environment</th>
                  <th scope="col" class="govuk-table__header">Recommended Channel</th>
                  <th scope="col" class="govuk-table__header">Current Channel</th>
                </tr>
              </thead>
              <tbody class="govuk-table__body">
                {% for rec in channelRecommendations.recommendations %}
                  <tr class="govuk-table__row">
                    <td class="govuk-table__cell" rowspan="3">{{ rec.componentName }}</td>
                    <td class="govuk-table__cell">Dev</td>
                    <td class="govuk-table__cell">{{ rec.environments.dev }}</td>
                    <td class="govuk-table__cell">
                      {% if rec.currentChannels.dev %}
                        {{ rec.currentChannels.dev }}
                      {% else %}
                        <span class="govuk-hint">Not configured</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr class="govuk-table__row">
                    <td class="govuk-table__cell">Preprod</td>
                    <td class="govuk-table__cell">{{ rec.environments.preprod }}</td>
                    <td class="govuk-table__cell">
                      {% if rec.currentChannels.preprod %}
                        {{ rec.currentChannels.preprod }}
                      {% else %}
                        <span class="govuk-hint">Not configured</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr class="govuk-table__row">
                    <td class="govuk-table__cell">Prod</td>
                    <td class="govuk-table__cell">{{ rec.environments.prod }}</td>
                    <td class="govuk-table__cell">
                      {% if rec.currentChannels.prod %}
                        {{ rec.currentChannels.prod }}
                      {% else %}
                        <span class="govuk-hint">Not configured</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </details>
        {% endif %}

        <div class="govuk-inset-text">
          <p class="govuk-body-s">
            <strong>Benefits of this structure:</strong>
          </p>
          <ul class="govuk-list govuk-list--bullet govuk-body-s">
            <li>Separates production alerts from non-production to reduce noise</li>
            <li>Centralizes team alerts in dedicated channels</li>
            <li>Follows consistent naming conventions</li>
            <li>Enables better alert management and response times</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}

{% block pageScripts %}
<script src="/assets/js/monitoringChannels.js"></script>
{% endblock %}
